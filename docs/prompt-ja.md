# similarity-ts: AIアシスタントガイド

## 目的
ASTベースの比較でTypeScript/JavaScriptの重複コードを検出し、リファクタリングを支援します。

## インストール
```bash
cargo install similarity-ts
```

## コマンド形式
```bash
similarity-ts [パス...] [オプション]
```

## 主要オプション
- `--threshold <0-1>`: 類似度しきい値（デフォルト: 0.8）
- `--min-tokens <n>`: n個未満のASTノードを持つ関数をスキップ（推奨: 20-30）
- `--print`: 実際のコードスニペットを表示

## AIリファクタリングワークフロー

### 1. 広範囲スキャン
コードベース全体の重複を発見：
```bash
similarity-ts src/ --threshold 0.85 --min-tokens 25
```

### 2. 詳細分析
特定のファイルペアを調査：
```bash
similarity-ts file1.ts file2.ts --threshold 0.8 --min-tokens 20 --print
```

### 3. しきい値調整
結果がない場合は段階的に下げる：
```bash
similarity-ts file1.ts file2.ts --threshold 0.75 --min-tokens 20
similarity-ts file1.ts file2.ts --threshold 0.7 --min-tokens 20
```

## 出力形式
```
Function: functionName (file.ts:開始行-終了行)
Similar to: otherFunction (other.ts:開始行-終了行)  
Similarity: 85%
```

## 効果的なしきい値
- `0.95+`: ほぼ同一（変数名の違いのみ）
- `0.85-0.95`: 同じアルゴリズム、軽微な違い
- `0.75-0.85`: 類似構造、詳細は異なる
- `0.7-0.75`: 関連ロジック、調査の価値あり

## リファクタリング戦略

1. **高いしきい値から開始**（0.9）で明らかな重複を発見
2. **特定ペアを比較**して類似性を確認
3. **--printを使用**して実際のコードの違いを確認
4. **共通ロジックを抽出**して共有関数/モジュール化
5. **リファクタリング後に再実行**して新たな重複がないか確認

## リファクタリング対象の一般的なパターン

- **データ処理ループ**（異なるフィールド名）
- **APIハンドラー**（類似のリクエスト/レスポンスロジック）
- **バリデーション関数**（異なるルール）
- **状態管理**（繰り返されるパターン）

## ベストプラクティス

- 正確な複雑さフィルタリングに`--min-tokens`を使用（20-30トークン）
- 80%以上の類似度のファイルを優先
- 類似関数が同じモジュール内にあるか確認（リファクタリングが容易）
- 関数サイズを考慮 - 大きな重複ほど影響大
- ペアだけでなく複数ファイルにまたがるパターンを探す